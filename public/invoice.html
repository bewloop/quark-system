<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Invoice | QUARK</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* { box-sizing: border-box; }

body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  padding: 20px;
}

/* ===== ACTION BAR (OUTSIDE FORM) ===== */
.top-actions {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 10px;
  gap: 10px;
}

button {
  padding: 8px 14px;
  background: #000;
  color: #fff;
  border: none;
  cursor: pointer;
}

/* ===== PAGE A4 FIX ===== */
.page {
  width: 210mm;
  min-height: 297mm;   /* ‚úÖ ‡πÉ‡∏ä‡πâ min-height */
  background: #fff;
  margin: auto;
  padding: 12mm;       /* ‡∏•‡∏î padding */
  color: #000;
  overflow: hidden;
}

.row { display: flex; justify-content: space-between; gap: 20px; }
.col { flex: 1; }

input, textarea, select {
  width: 100%;
  border: none;
  border-bottom: 1px solid #000;
  padding: 4px;
  font-size: 14px;
}

input[readonly], textarea[readonly] {
  background: #fafafa;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}

th {
  font-size: 13px;
  padding: 6px;
  border: 1px solid #000;
}

td {
  border: 1px solid #000;
  padding: 3px;
  font-size: 12px;
  height: 28px;
}

td input, td textarea {
  border: none;
  font-size: 12px;
  width: 100%;
}

td textarea {
  resize: none;
  height: 28px;
}

.summary-wrap {
  display: flex;
  gap: 20px;
  margin-top: 10px;
}

.note-box {
  flex: 1;
  border: 1px solid #000;
  padding: 8px;
}

.summary {
  width: 45%;
}

.summary td { border: none; }
.summary input { text-align: right; }

.footer-text {
  margin-top: 10px;
  font-size: 14px;
}

.signature-wrapper {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;   /* ‚≠ê ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
  margin-top: 60px;
}

.signature-block {
  width: 45%;
  text-align: center;
}

.signature-line {
  border-top: 1px solid #000;
  margin-top: 40px;  /* ‚≠ê ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
  padding-top: 6px;
}

.signature-company {
  margin-bottom: 40px;  /* ‚≠ê ‡∏î‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÄ‡∏™‡πâ‡∏ô */
}

/* ================= PRINT ================= */
@media print {
  body {
    padding: 0;
    margin: 0;
    background: #fff;
    zoom: 0.85;          /* üî• ‡∏Ñ‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö + ‡∏™‡∏≥‡πÄ‡∏ô‡∏≤ */
  }

  /* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° */
  .top-actions,
  .actions {
    display: none !important;
  }

  /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤ */
  .signatures,
  .footer-text {
    page-break-inside: avoid;
  }

  table {
    font-size: 12px;
  }

  .company-name {
    font-size: 18px;
    font-weight: bold;
    line-height: 1.1;
    max-width: 700px;
    white-space: normal;
    word-break: break-word;
    margin-bottom: 4px;
  }

  @page {
    size: A4;
    margin: 8mm;
  }
}

@media print {
  .page {
    page-break-after: always;   /* ‚≠ê ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏à‡∏ö‡∏´‡∏ô‡πâ‡∏≤ */
    height: 297mm;              /* ‚≠ê FIX ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏à‡∏£‡∏¥‡∏á */
    overflow: hidden;           /* ‚≠ê ‡∏´‡πâ‡∏≤‡∏°‡∏•‡πâ‡∏ô */
  }

  #copy-container .page:last-child {
    page-break-after: auto;     /* ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ï‡∏Å */
  }
}

/* ===== RECEIPT ONLY ===== */
.receipt-page .credit-row {
  display: none;
}

.receipt-page .signature-left::before {
  content: "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô";
}

.receipt-page .signature-right::before {
  content: "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏≠‡∏≥‡∏ô‡∏≤‡∏à";
}

/* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏° */
.receipt-page .signature-left .signature-line,
.receipt-page .signature-right .signature-line {
  display: none;
}

select {
  caret-color: transparent;
}


</style>
</head>

<body>

<!-- ACTIONS OUTSIDE FORM -->
<div class="top-actions">
  <button onclick="saveInvoice()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  <button onclick="window.print()">‡∏û‡∏¥‡∏°‡∏û‡πå</button>
</div>

<div class="invoice-page">
<div id="invoice-template" class="page">

  <!-- HEADER -->
  <div class="row">
    <div class="col">
      <div style="display:flex;align-items:center;gap:4px">
        <img src="images/logotbt.png" style="height:50px">
        <div class="company-name">
          <b>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏¥‡∏•‡∏ö‡∏µ‡πÄ‡∏ó‡∏£‡∏î‡∏î‡∏¥‡πâ‡∏á ‡∏à‡∏≥‡∏Å‡∏±‡∏î</b><br>
          295/1 ‡∏´‡∏°‡∏π‡πà 1 ‡∏ñ‡∏ô‡∏ô‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô 5 ‡∏ã‡∏≠‡∏¢ 5 ‡∏ï‡∏≥‡∏ö‡∏•‡πÅ‡∏Ñ‡∏£‡∏≤‡∏¢ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏Å‡∏£‡∏∞‡∏ó‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ô ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£ 74110<br>
          ‡πÇ‡∏ó‡∏£ 02-100-4580<br>
          ‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ 0105557103812
        </div>
      </div>
    </div>

    <div class="col" style="text-align:right">
      <div id="copyType" class="copy-label">‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</div>
      <b id="docTitle">‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ / ‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</b>
    </div>
  </div>

  <!-- CUSTOMER -->
  <div class="row" style="margin-top:18px">
    <div class="col">
      ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:
      <select id="customerSelect"></select>
      ‡∏ä‡∏∑‡πà‡∏≠:
      <input id="customerName" readonly>
      ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:
      <textarea id="customerAddress" rows="2" readonly></textarea>
      ‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ:
      <input id="customerTax" readonly>
    </div>

    <div class="col credit-row">>
      ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:
      <input id="invoiceNo" readonly>
      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:
      <input type="date" id="invoiceDate">
      ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (‡∏ß‡∏±‡∏ô):
      <input type="number" id="creditDays" value="0">
      ‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î:
      <input type="date" id="dueDate" readonly>
    </div>
  </div>

  <!-- ITEMS -->
  <table>
    <thead>
      <tr>
        <th width="40">NO</th>
        <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
        <th width="70">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
        <th width="90">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡∏∞</th>
        <th width="110">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
  </table>

  <!-- NOTE + SUMMARY -->
  <div class="summary-wrap">
    <div class="note-box">
      <b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</b><br>
      <textarea rows="4" style="border:none;width:100%;resize:none"></textarea>
    </div>

    <table class="summary">
      <tr><td>‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</td><td><input id="totalAmount" readonly></td></tr>
      <tr><td>‡∏´‡∏±‡∏Å ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</td><td><input id="discount" value="0"></td></tr>
      <tr><td>‡∏¢‡∏≠‡∏î‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</td><td><input id="afterDiscount" readonly></td></tr>
      <tr><td>‡∏´‡∏±‡∏Å ‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</td><td><input id="deposit" value="0"></td></tr>
      <tr><td>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</td><td><input id="netAmount" readonly></td></tr>
      <tr><td>VAT 7%</td><td><input id="vatAmount" readonly></td></tr>
      <tr><td><b>‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</b></td><td><input id="grandTotal" readonly></td></tr>
    </table>
  </div>

  <!-- FOOTER -->
  <div class="footer-text">
    ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£
  </div>

  <!-- SIGNATURE -->
<div class="signature-wrapper">

  <div class="signature-block">
    <div class="signature-line"></div>
    ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤<br>
    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà _____ / _____ / _____
  </div>

  <div class="signature-block">
    <div class="signature-company">
      ‡πÉ‡∏ô‡∏ô‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ó‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏¥‡∏•‡∏ö‡∏µ‡πÄ‡∏ó‡∏£‡∏î‡∏î‡∏¥‡πâ‡∏á ‡∏à‡∏≥‡∏Å‡∏±‡∏î
    </div>
    <div class="signature-line"></div>
    ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≠‡∏ö‡∏≠‡∏≥‡∏ô‡∏≤‡∏à<br>
    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà _____ / _____ / _____
  </div>

</div>

</div>
</div>

<div id="copy-container"></div>

<script>
const MAX_ROWS = 10;
const params = new URLSearchParams(location.search);
const invoiceId = params.get('id');

/* ===== customers ===== */
async function loadCustomers() {
  const res = await fetch('/api/customers');
  const customers = await res.json();

  customerSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ --</option>';
  customers.forEach(c => {
    customerSelect.innerHTML += `
      <option value="${c.id}">${c.customer_code} - ${c.name}</option>
    `;
  });

  customerSelect.onchange = () => {
    const c = customers.find(x => x.id == customerSelect.value);
    if (!c) return;
    customerName.value = c.name;
    customerAddress.value = c.address;
    customerTax.value = c.tax_id;
  };
}

/* ===== rows (LOCK 10) ===== */
function addRow(item = {}) {
  if (itemsBody.children.length >= MAX_ROWS) return;

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${itemsBody.children.length + 1}</td>
    <td><textarea>${item.description || ''}</textarea></td>
    <td><input type="number" value="${item.qty || ''}" oninput="calcRow(this)"></td>
    <td><input type="number" value="${item.unit_price || ''}" oninput="calcRow(this)"></td>
    <td><input readonly value="${item.total || ''}"></td>
  `;
  itemsBody.appendChild(tr);
  calcSummary();
}

/* ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ñ‡∏ß‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 10 */
function fillEmptyRows() {
  while (itemsBody.children.length < MAX_ROWS) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${itemsBody.children.length + 1}</td>
      <td></td><td></td><td></td><td></td>
    `;
    itemsBody.appendChild(tr);
  }
}

/* ===== calc ===== */
function calcRow(el) {
  const tr = el.closest('tr');
  const qty = +tr.children[2].querySelector('input').value || 0;
  const price = +tr.children[3].querySelector('input').value || 0;
  tr.children[4].querySelector('input').value = (qty * price).toFixed(2);
  calcSummary();
}

function calcSummary() {
  let total = 0;
  document.querySelectorAll('#itemsBody tr').forEach(tr => {
    const v = tr.children[4].querySelector('input');
    if (v) total += +v.value || 0;
  });

  totalAmount.value = total.toFixed(2);
  afterDiscount.value = (total - (+discount.value || 0)).toFixed(2);
  netAmount.value = (afterDiscount.value - (+deposit.value || 0)).toFixed(2);
  vatAmount.value = (netAmount.value * 0.07).toFixed(2);
  grandTotal.value = (+netAmount.value + +vatAmount.value).toFixed(2);
}

discount.addEventListener('input', calcSummary);
deposit.addEventListener('input', calcSummary);

creditDays.addEventListener('input', () => {
  if (!invoiceDate.value) return;
  const d = new Date(invoiceDate.value);
  d.setDate(d.getDate() + (+creditDays.value || 0));
  dueDate.value = d.toISOString().slice(0,10);
});

/* ===== load invoice ===== */
async function loadInvoice() {
  const res = await fetch(`/api/invoices/${invoiceId}`);
  const data = await res.json();
  const i = data.invoice;

  invoiceNo.value = i.invoice_no || i.receipt_no;
  invoiceDate.value = i.invoice_date?.slice(0,10);
  creditDays.value = i.credit_days;
  dueDate.value = i.due_date?.slice(0,10);

  customerSelect.value = i.customer_id;
  customerName.value = i.customer_name;
  customerAddress.value = i.customer_address;
  customerTax.value = i.customer_tax;

  discount.value = i.discount || 0;
  deposit.value = i.deposit || 0;

  data.items.slice(0, MAX_ROWS).forEach(addRow);
  fillEmptyRows();
  calcSummary();
}

async function loadNextInvoiceNo() {
  const res = await fetch('/api/invoices/next-number');
  const data = await res.json();
  invoiceNo.value = data.invoice_no;
}

/* ===== save ===== */
async function saveInvoice() {
  if (!customerSelect.value) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤');

  const items = [];
  document.querySelectorAll('#itemsBody tr').forEach((tr, i) => {
    const desc = tr.children[1].querySelector('textarea');
    if (!desc || !desc.value) return;

    items.push({
      item_no: i + 1,
      description: desc.value,
      qty: +tr.children[2].querySelector('input').value,
      unit_price: +tr.children[3].querySelector('input').value,
      total: +tr.children[4].querySelector('input').value
    });
  });

  const payload = {
    customer_id: customerSelect.value,
    invoice_date: invoiceDate.value,
    credit_days: creditDays.value,
    due_date: dueDate.value,
    totals: {
      total: +totalAmount.value,
      discount: +discount.value,
      afterDiscount: +afterDiscount.value,
      deposit: +deposit.value,
      net: +netAmount.value,
      vat: +vatAmount.value,
      grand: +grandTotal.value
    },
    items
  };

  const res = await fetch('/api/invoices', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const result = await res.json();
  alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n${result.invoice_no} / ${result.receipt_no}`);
  location.href = '/invoice-index.html';
}

/* ===== init ===== */
loadCustomers();
invoiceDate.valueAsDate = new Date();
addRow();
fillEmptyRows();

if (invoiceId) {
  loadInvoice();
} else {
  loadNextInvoiceNo(); // ‚≠ê ‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
}

/* ===== PRINT COPY ===== */
window.addEventListener('beforeprint', () => {
  const original = document.getElementById('invoice-template');
  const container = document.getElementById('copy-container');
  container.innerHTML = '';

  /* ===== PAGE 2 : ‡∏™‡∏≥‡πÄ‡∏ô‡∏≤ ===== */
  const copy = original.cloneNode(true);
  copy.querySelector('#copyType').innerText = '‡∏™‡∏≥‡πÄ‡∏ô‡∏≤';
  copy.querySelector('#docTitle').innerText = '‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ / ‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á';
  container.appendChild(copy);

  /* ===== PAGE 3 : ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ===== */
    const receipt = original.cloneNode(true);
    receipt.classList.add('receipt-page'); // ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å

    receipt.querySelector('#copyType').innerText = '‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö';
    receipt.querySelector('#docTitle').innerText = '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô';

    /* ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï */
    receipt.querySelector('#creditDays').value = '';
    receipt.querySelector('#dueDate').value = '';

    container.appendChild(receipt);
});

window.addEventListener('afterprint', () => {
  document.getElementById('copy-container').innerHTML = '';
});

async function loadInvoiceNo() {
  try {
    const res = await fetch('/api/invoices/next-number/iv');
    const data = await res.json();

    document.getElementById('invoiceNo').value = data.invoice_no;
  } catch (err) {
    console.error(err);
    document.getElementById('invoiceNo').value = '';
  }
}

window.addEventListener('DOMContentLoaded', loadInvoiceNo);
</script>

</body>
</html>