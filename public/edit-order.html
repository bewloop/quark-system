<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Edit Order | QUARK</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f2f2f2;
}

.page {
  max-width: 700px;
  margin: 30px auto;
  padding: 0 20px;
}

/* ===== TOP BAR ===== */
.top-bar {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  margin-bottom: 12px;
}

.top-bar button {
  padding: 6px 14px;
  font-size: 13px;
  border-radius: 8px;
  border: none;
  background: #000;
  color: #fff;
  cursor: pointer;
}

.top-bar button:hover { opacity: .85; }

/* ===== CARD ===== */
.card {
  background: #fff;
  border-radius: 14px;
  padding: 28px;
  box-shadow: 0 6px 20px rgba(0,0,0,.05);
}

/* ===== TITLE ===== */
h1 {
  margin: 0 0 24px;
  text-align: center;
  font-size: 28px;
}

/* ===== FORM ===== */
label {
  display: block;
  margin-top: 14px;
  font-size: 13px;
  color: #444;
}

input,
select,
textarea {
  width: 100%;
  padding: 10px 12px;
  margin-top: 6px;
  border-radius: 8px;
  border: 1px solid #ddd;
  font-size: 13px;
}

textarea {
  resize: vertical;
  min-height: 80px;
}

input[disabled] {
  background: #eee;
}

/* ===== ACTION ===== */
.submit-btn {
  margin-top: 28px;
  width: 100%;
  padding: 12px;
  background: #000;
  color: #fff;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  cursor: pointer;
}

.submit-btn:hover { opacity: .9; }

/* ===== LOGO ===== */
.logo-img {
  width: 1000px;
  max-width: 100%;
  height: auto;
  display: block;
  margin: 0 auto 20px;
}
</style>
</head>

<body>

<div class="page">

  <!-- TOP BAR -->
  <div class="top-bar">
    <button onclick="history.back()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
    <button onclick="logout()">Log out</button>
  </div>

  <!-- LOGO -->
  <img src="images/logo.png" class="logo-img" alt="QUARK Logo">

  <!-- CARD -->
  <div class="card">
    <h1>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h1>

    <form id="orderForm">

      <label>Order ID</label>
      <input id="order_id" disabled>

      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô</label>
      <input type="date" id="order_date" required>

      <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Ç‡∏≤‡∏¢</label>
      <select id="channel">
        <option>LAZM</option>
        <option>LAZFL</option>
        <option>Shopee Q1</option>
        <option>Shopee Q3</option>
        <option>Shopee Q4</option>
        <option>Line Q1</option>
        <option>Line Q2</option>
        <option>Line Q3</option>
        <option>Facebook</option>
        <option>Tiktok Q1</option>
        <option>Tiktok Q3</option>
        <option>‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</option>
      </select>

      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
      <input id="customer">

      <label>‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ</label>
      <input id="car_model">

      <label>‡∏õ‡∏µ‡∏£‡∏ñ</label>
      <input id="car_year">

      <label>‡∏™‡∏µ‡∏û‡∏£‡∏°</label>
      <input id="mat_color">

      <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏£‡∏°</label>
      <select id="mat_type">
        <option value="‡∏û‡∏£‡∏°6D">‡∏û‡∏£‡∏° 6D</option>
        <option value="‡∏û‡∏£‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°">‡∏û‡∏£‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°</option>
        <option value="‡∏û‡∏£‡∏°VIP">‡∏û‡∏£‡∏° VIP</option>
        <option value="‡∏û‡∏£‡∏°‡∏î‡∏±‡∏Å‡∏ù‡∏∏‡πà‡∏ô">‡∏û‡∏£‡∏°‡∏î‡∏±‡∏Å‡∏ù‡∏∏‡πà‡∏ô</option>
      </select>

      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
      <input type="number" id="mat_qty" min="1">

      <label>‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
      <select id="payment_status">
        <option value="‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞">‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</option>
        <option value="‡πÇ‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß">‡πÇ‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option>
        <option value="‡∏à‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏û">‡∏à‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏û</option>
        <option value="COD">COD</option>
        <option value="VAT‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß">VAT ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option>
        <option value="VAT‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞">VAT ‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</option>
      </select>

      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
      <textarea id="note"></textarea>

      <button class="submit-btn" type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>

    </form>
  </div>

</div>

<script>
const params = new URLSearchParams(location.search);
const orderId = params.get('id');

if (!orderId) {
  alert('‡πÑ‡∏°‡πà‡∏û‡∏ö Order ID');
  history.back();
}

/* LOAD ORDER */
(async () => {
  const res = await fetch(`/api/orders/${orderId}`, {
    credentials: 'include'
  });

  if (!res.ok) {
    alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return history.back();
  }

  const o = await res.json();

  order_id.value = o.id;
  order_date.value =
    o.order_date?.substring(0,10)
    || o.created_at?.substring(0,10)
    || '';

  channel.value = o.channel || '';
  customer.value = o.customer || '';
  car_model.value = o.car_model || '';
  car_year.value = o.car_year || '';
  mat_color.value = o.mat_color || '';
  mat_type.value = o.mat_type || '';
  mat_qty.value = o.mat_qty || 1;
  payment_status.value = o.payment_status || '';
  note.value = o.note || '';
})();

/* SAVE */
document.getElementById('orderForm').onsubmit = async (e) => {
  e.preventDefault();

  const payload = {
    order_date: order_date.value,
    channel: channel.value,
    customer: customer.value.trim(),
    car_model: car_model.value.trim(),
    car_year: car_year.value.trim(),
    mat_color: mat_color.value.trim(),
    mat_type: mat_type.value,
    mat_qty: Number(mat_qty.value) || 1,
    payment_status: payment_status.value,
    note: note.value.trim()
  };

  const res = await fetch(`/api/orders/${orderId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return;
  }

  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  location.href = '/order.html';
};

/* LOGOUT */
async function logout() {
  await fetch('/api/logout', {
    method: 'POST',
    credentials: 'include'
  });
  location.href = 'login.html';
}
</script>

</body>
</html>
