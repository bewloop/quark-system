<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Edit Order | QUARK</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f5f5f5;
}

.top-actions {
  position: fixed;
  top: 16px;
  right: 16px;
}

.top-actions button {
  margin-left: 8px;
  padding: 6px 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  background: #000;
  color: #fff;
  font-size: 12px;
}

.container {
  max-width: 520px;
  margin: 90px auto;
  background: #fff;
  padding: 30px;
  border-radius: 12px;
}

h2 {
  margin-top: 0;
  text-align: center;
}

label {
  font-size: 13px;
  margin-top: 14px;
  display: block;
}

input, select, textarea {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

input[disabled] {
  background: #eee;
}

button.submit-btn {
  margin-top: 28px;
  width: 100%;
  padding: 12px;
  background: #000;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  cursor: pointer;
}
</style>
</head>

<body>

<div class="top-actions">
  <button onclick="history.back()">Back</button>
  <button onclick="logout()">Logout</button>
</div>

<div class="container">
<h2>Edit Order</h2>

<form id="orderForm">

  <label>Order ID</label>
  <input id="order_id" disabled>

  <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô</label>
  <input type="date" id="order_date" required>

  <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Ç‡∏≤‡∏¢</label>
  <select id="channel">
    <option>LAZM</option>
    <option>LAZFL</option>
    <option>Shopee Q1</option>
    <option>Shopee Q3</option>
    <option>Shopee Q4</option>
    <option>Line Q1</option>
    <option>Line Q3</option>
    <option>Facebook</option>
    <option>Tiktok Q1</option>
    <option>Tiktok Q3</option>
    <option>‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</option>
  </select>

  <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
  <input id="customer">

  <label>‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ</label>
  <input id="car_model">

  <label>‡∏õ‡∏µ‡∏£‡∏ñ</label>
  <input id="car_year">

  <label>‡∏™‡∏µ‡∏û‡∏£‡∏°</label>
  <input id="mat_color">

  <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏£‡∏°</label>
  <select id="mat_type">
    <option value="‡∏û‡∏£‡∏°6D">‡∏û‡∏£‡∏° 6D</option>
    <option value="‡∏û‡∏£‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°">‡∏û‡∏£‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°</option>
    <option value="‡∏û‡∏£‡∏°VIP">‡∏û‡∏£‡∏° VIP</option>
    <option value="‡∏û‡∏£‡∏°‡∏î‡∏±‡∏Å‡∏ù‡∏∏‡πà‡∏ô">‡∏û‡∏£‡∏°‡∏î‡∏±‡∏Å‡∏ù‡∏∏‡πà‡∏ô</option>
  </select>

  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
  <input type="number" id="mat_qty" min="1">

  <label>‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
  <select id="payment_status">
    <option value="‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</option>
    <option value="‡∏à‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏û">‡∏à‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏û</option>
    <option value="COD">COD</option>
    <option value="VAT‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß">VAT ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option>
    <option value="VAT‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞">VAT ‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞</option>
  </select>

  <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
  <textarea id="note"></textarea>

  <button class="submit-btn" type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
</form>
</div>

<script>
const params = new URLSearchParams(location.search);
const orderId = params.get('id');

if (!orderId) {
  alert('‡πÑ‡∏°‡πà‡∏û‡∏ö Order ID');
  history.back();
}

/* LOAD ORDER */
(async () => {
  const res = await fetch(`/api/orders/${orderId}`, {
    credentials: 'include' // ‚≠ê ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å
  });

  if (!res.ok) {
    alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return history.back();
  }

  const o = await res.json();

  order_id.value = o.id;
  order_date.value = o.order_date?.substring(0,10) || '';
  channel.value = o.channel || '';
  customer.value = o.customer || '';
  car_model.value = o.car_model || '';
  car_year.value = o.car_year || '';
  mat_color.value = o.mat_color || '';
  mat_type.value = o.mat_type || '';
  mat_qty.value = o.mat_qty || 1;
  payment_status.value = o.payment_status || '';
  note.value = o.note || '';
})();

/* SAVE */
document.getElementById('orderForm').onsubmit = async (e) => {
  e.preventDefault();

  const payload = {
    order_date: order_date.value,
    channel: channel.value,
    customer: customer.value.trim(),
    car_model: car_model.value.trim(),
    car_year: car_year.value.trim(),
    mat_color: mat_color.value.trim(),
    mat_type: mat_type.value,
    mat_qty: Number(mat_qty.value) || 1,
    payment_status: payment_status.value,
    note: note.value.trim()
  };

  const res = await fetch(`/api/orders/${orderId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return;
  }

  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
  location.href = `order-detail.html?id=${orderId}`;
};

/* LOGOUT */
async function logout() {
  await fetch('/api/logout', {
    method: 'POST',
    credentials: 'include'
  });
  location.href = 'login.html';
}
</script>

</body>
</html>
